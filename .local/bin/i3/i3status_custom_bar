#!/bin/bash

# Modified version based on Keheliya Gallaba script :
# https://keheliya.blogspot.com/2018/01/weather-info-in-i3status.html
# Requires numlockx and ncmpcpp to be installed... and used.
# Brightness works for amdgpu chipset.
# $size checks my fetchmail/mutt inbox for new mail

# Import (Pywal) colors
. "$HOME/.cache/wal/colors.sh"

# Call i3status
i3status | (read line && echo "$line" && read line && echo "$line" && read line && echo "$line" && while :
do
  	read line

# Change this color to change the main text color
linecolor=${color7}

# Import list of upgradeable packages
. "$HOME/.local/etc/pkg-status"

	# calculate memory use
	memtotal=$(cat /proc/meminfo |grep MemTotal|cut -d: -f 2|cut -dk -f 1)
	memfree=$(cat /proc/meminfo |grep MemFree|cut -d: -f 2|cut -dk -f 1|xargs)
	mempercent=$((($memtotal-$memfree)*100/$memtotal))
	swptotal=$(cat /proc/meminfo |grep SwapTotal|cut -d: -f 2|cut -dk -f 1)
	swpfree=$(cat /proc/meminfo |grep SwapFree|cut -d: -f 2|cut -dk -f 1|xargs)
	swppercent=$((($swptotal-$swpfree)*100/$swptotal))

	# show current song title
	artist=$(ncmpcpp --current-song "%a"|cut -d";" -f 2)
	title=$(ncmpcpp --current-song "%t"|cut -d"(" -f 1)
	if [ -d ${artist} ]; then
		icon=""
		sep=""
	else 	icon=""
		sep="-"
	fi

	# display current brightness
	bt=$(cat /sys/class/backlight/intel_backlight/actual_brightness)
	btp=$(($bt*100/4648))


	# check new mail in $HOME/.mutt inboxes using file size
	size0=$(stat --printf="%s" /home/fuzzbox/.mutt/perso/inbox)
	size1=$(stat --printf="%s" /home/fuzzbox/.mutt/pro/inbox)
	size2=$(stat --printf="%s" /home/fuzzbox/.mutt/gmail/inbox)
	if [ $size0 = "0" ] && [ $size1 = "0" ] && [ $size2 = "0" ]; then
		mcolor=${linecolor}
		mailtxt="No mail"
		check=""
	else
		mcolor="${color5}"
		mailtxt="Got mail"
		check=""
	fi

	# display fan speed
	fan=$(cat /proc/acpi/ibm/fan |grep speed |cut -d: -f 2 |xargs)

# layout of the data displayed in i3bar before the standard i3status data
echo ",[{\"full_text\":\"${icon}  ${artist} ${sep} ${title}\",\"color\":\"${linecolor}\" },{\"full_text\":\"${check} ${mailtxt}\",\"color\":\"${mcolor}\" },{\"full_text\":\"Mem ${mempercent}% - ${swppercent}%\",\"color\":\"${linecolor}\" },{\"full_text\":\" ${btp}%\",\"color\":\"${linecolor}\" },{\"full_text\":\" $upgradeable pkg / $installed\",\"color\":\"${linecolor}\" },{\"full_text\":\"${fan} rpm\",\"color\":\"${linecolor}\" },${line#,\[}" || exit 1
done)
